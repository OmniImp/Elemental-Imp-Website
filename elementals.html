<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elemental Imp - Elementals</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="flame" aria-hidden="true"></div>
  <main class="container">
    <header class="header center">
      <div class="logo">ðŸ”¥ ELEMENTAL IMP ðŸ”¥</div>
      <div class="tag">Masters of the Elements</div>
    </header>

    <nav class="nav-bar">
      <a href="index.html" class="btn">Home</a>
      <a href="imps.html" class="btn">Imps</a>
      <a href="levels-of-hell.html" class="btn">Levels of Hell</a>
      <a href="elementals.html" class="btn active">Elementals</a>
      <a href="bestiary.html" class="btn">Bestiary</a>
      <a href="media.html" class="btn">Media</a>
      <a href="contact.html" class="btn">Contact</a>
    </nav>

    <section>
      <h2 class="logo">Elementals</h2>
      <p style="margin-top:12px">
        The pure embodiments of the elements. Add or edit them below.
      </p>

      <div class="actions">
        <button class="add-card" data-target="#cards-elementals">+ Add Elemental</button>
      </div>

      <div class="cards" id="cards-elementals">
        <div class="card">
          <button class="remove-card" title="Remove this card">Ã—</button>
          <div class="image" title="Click to upload or drop an image">
            Image <input type="file" accept="image/*">
          </div>
          <div class="name" contenteditable="true">Element Name</div>
          <div class="desc" contenteditable="true">Describe powers, abilities, and lore.</div>
        </div>
      </div>
    </section>

    <template id="elemental-card-template">
      <div class="card">
        <button class="remove-card" title="Remove this card">Ã—</button>
        <div class="image" title="Click to upload or drop an image">
          Image <input type="file" accept="image/*">
        </div>
        <div class="name" contenteditable="true">Element Name</div>
        <div class="desc" contenteditable="true">Describe powers, abilities, and lore.</div>
      </div>
    </template>

    <footer class="footer">
      <div>Follow: Discord â€¢ Twitter â€¢ Steam â€¢ itch.io</div>
    </footer>
  </main>

<script>
  
(function(){
  const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
  const KEY = 'elementalImp:' + here;

  function $(sel, ctx=document){ return Array.from(ctx.querySelectorAll(sel)); }
  function debounce(fn, ms=400){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
  function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); 
  }
  
function getBoxImage(box){
  if (!box) return '';
  // Prefer the data attribute (always present after we set an image)
  const ds = box.getAttribute('data-src');
  if (ds) return ds;

  // Fallback to reading background-image
  const bg = (box.style && box.style.backgroundImage) || '';
  const m = bg.match(/url\((['"]?)(.*?)\1\)/i);
  return m ? m[2] : '';
}

function setBoxImage(box, src){
  if(!src || !box) return;
  // Save the raw data for reliable autosave
  box.setAttribute('data-src', src);

  // Paint preview
  const input = box.querySelector('input[type="file"]');
  box.style.backgroundImage = `url(${src})`;
  box.classList.add('has-img');
  box.textContent = '';
  if (input) box.appendChild(input);
}

  async function collect(){
    const textBlocks = $('[contenteditable="true"]').map(el => el.textContent.trim());
    const imgBoxes = $('.image').map(getBoxImage);
    return { page: here, textBlocks, imgBoxes };
  }
  function apply(data){
    if (!data || data.page !== here) return;
    const texts = $('[contenteditable="true"]');
    (data.textBlocks || []).forEach((v,i)=> { if (texts[i]) texts[i].textContent = v || texts[i].textContent; });
    const boxes = $('.image');
    (data.imgBoxes || []).forEach((src,i)=> { if (boxes[i] && src) setBoxImage(boxes[i], src); });
  }
  const autosave = debounce(() => { collect().then(data=>{ try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){ console.error(e); } }); }, 400);
  function loadNow(){ try{ const raw=localStorage.getItem(KEY); if (!raw) return; apply(JSON.parse(raw)); }catch(e){ console.error(e); } }

  function wireImageBox(box){
    const input = box.querySelector('input[type="file"]');
    if (input && !input.dataset.wired){
      input.dataset.wired = '1';
      input.addEventListener('change', async e=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        setBoxImage(box, await fileToDataURL(f));
        autosave();
      });
    }
    ['dragenter','dragover'].forEach(ev=> box.addEventListener(ev, e=>{ e.preventDefault(); box.style.boxShadow='0 0 18px rgba(255,69,0,.85)'; }));
    ['dragleave','drop'].forEach(ev=> box.addEventListener(ev, e=>{ e.preventDefault(); box.style.boxShadow=''; }));
    box.addEventListener('drop', async e=>{
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return;
      setBoxImage(box, await fileToDataURL(f));
      autosave();
    });
  }
  function wireCard(card){
    if (card.dataset.wired) return;
    card.dataset.wired = '1';
    const rm = card.querySelector('.remove-card');
    rm && rm.addEventListener('click', ()=>{ card.remove(); autosave(); });
    card.querySelectorAll('[contenteditable="true"]').forEach(el=>{
      el.addEventListener('input', autosave);
      el.addEventListener('blur', autosave);
    });
    const box = card.querySelector('.image');
    if (box) wireImageBox(box);
  }

  document.addEventListener('DOMContentLoaded', () => {
    $('.cards .card').forEach(wireCard);
    loadNow();

    let template = document.getElementById('elemental-card-template');
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.add-card');
      if (!btn) return;
      let container = document.querySelector(btn.dataset.target);
      if (!container){
        container = document.createElement('div');
        container.className = 'cards';
        btn.insertAdjacentElement('afterend', container);
      }
      const card = template.content.firstElementChild.cloneNode(true);
      wireCard(card);
      container.appendChild(card);
      card.scrollIntoView({behavior:'smooth', block:'center'});
      autosave();
    });
  });
})();
</script>
</body>
</html>
