<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elemental Imp - Bestiary</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="flame" aria-hidden="true"></div>
  <main class="container">
    <header class="header center">
      <div class="logo">ðŸ”¥ ELEMENTAL IMP ðŸ”¥</div>
      <div class="tag">Descend the Nine Levels of Hell</div>
    </header>

    <nav class="nav-bar">
  <a href="index.html" class="btn" style="padding:8px 12px;margin-right:8px">Home</a>
  <a href="imps.html" class="btn" style="padding:8px 12px;margin-right:8px">Imps</a>
  <a href="levels-of-hell.html" class="btn" style="padding:8px 12px;margin-right:8px">Levels of Hell</a>
  <a href="elementals.html" class="btn" style="padding:8px 12px;margin-right:8px">Elementals</a>
  <a href="bestiary.html" class="btn" style="padding:8px 12px;margin-right:8px">Bestiary</a>
  <a href="media.html" class="btn" style="padding:8px 12px;margin-right:8px">Media</a>
  <a href="contact.html" class="btn" style="padding:8px 12px">Contact</a>
</nav>


<section>
  <h2 class="logo">Bestiary</h2>
  <p style="margin-top:12px">There are four demon tiers: Fiends, Lesser Demons, Mid-Demons, and Greater Demons.</p>

  <!-- One action bar + one grid -->
  <div class="actions">
    <button class="add-card" data-target="#cards-bestiary">+ Add demon</button>
  </div>

  <div class="cards" id="cards-bestiary">
    <div class="card">
      <button class="remove-card" title="Remove this card">Ã—</button>
      <div class="image" title="Click to upload or drop an image" data-src="">
        Image <input type="file" accept="image/*">
      </div>
      <div class="name" contenteditable="true">Name</div>
      <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
    </div>
    <div class="card">
      <button class="remove-card" title="Remove this card">Ã—</button>
      <div class="image" title="Click to upload or drop an image" data-src="">
        Image <input type="file" accept="image/*">
      </div>
      <div class="name" contenteditable="true">Name</div>
      <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
    </div>
    <div class="card">
      <button class="remove-card" title="Remove this card">Ã—</button>
      <div class="image" title="Click to upload or drop an image" data-src="">
        Image <input type="file" accept="image/*">
      </div>
      <div class="name" contenteditable="true">Name</div>
      <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
    </div>
    <div class="card">
      <button class="remove-card" title="Remove this card">Ã—</button>
      <div class="image" title="Click to upload or drop an image" data-src="">
        Image <input type="file" accept="image/*">
      </div>
      <div class="name" contenteditable="true">Name</div>
      <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
    </div>
    <div class="card">
      <button class="remove-card" title="Remove this card">Ã—</button>
      <div class="image" title="Click to upload or drop an image" data-src="">
        Image <input type="file" accept="image/*">
      </div>
      <div class="name" contenteditable="true">Name</div>
      <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
    </div>
    <div class="card">
      <button class="remove-card" title="Remove this card">Ã—</button>
      <div class="image" title="Click to upload or drop an image" data-src="">
        Image <input type="file" accept="image/*">
      </div>
      <div class="name" contenteditable="true">Name</div>
      <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
    </div>
  </div>
</section>

    <!-- Hidden template for new demon cards -->
    <template id="card-template">
      <div class="card">
        <button class="remove-card" title="Remove this card">Ã—</button>
        <div class="image" title="Click to upload or drop an image" data-src="">Image<input type="file" accept="image/*"></div>
        <div class="name" contenteditable="true">Name</div>
        <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
      </div>
    </template>

    <script>
/* Single-grid "+ Add demon" for Bestiary */
document.addEventListener('DOMContentLoaded', () => {
  // click handler
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.add-card');
    if (!btn) return;

    // Find/ensure our single container
    let container = document.querySelector(btn.dataset.target || '#cards-bestiary');
    if (!container) {
      container = document.createElement('div');
      container.className = 'cards';
      container.id = 'cards-bestiary';
      btn.insertAdjacentElement('afterend', container);
    }

    // Ensure template
    let template = document.getElementById('card-template');
    if (!template) {
      template = document.createElement('template');
      template.id = 'card-template';
      template.innerHTML = `
        <div class="card">
          <button class="remove-card" title="Remove this card">Ã—</button>
          <div class="image" title="Click to upload or drop an image">
            Image <input type="file" accept="image/*">
          </div>
          <div class="name" contenteditable="true">Name</div>
          <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
        </div>`;
      document.body.appendChild(template);
    }

    // Helpers reused from your main script (fallbacks provided)
    const fileToDataURL = window.fileToDataURL || (f => new Promise(r => { const rd = new FileReader(); rd.onload = () => r(rd.result); rd.readAsDataURL(f); }));
    const setBoxImage = window.setBoxImage || ((box, src) => {
      if (!src) return;
      const input = box.querySelector('input[type="file"]');
      box.style.backgroundImage = `url(${src})`;
      box.classList.add('has-img');
      box.textContent = '';
      if (input) box.appendChild(input);
    });
    const autosave = window.autosave || (()=>{});

    // Wire a card (remove + uploads + text autosave)
    function wireCard(card){
      card.querySelector('.remove-card')?.addEventListener('click', ()=>{ card.remove(); autosave(); });
      card.querySelectorAll('[contenteditable="true"]').forEach(el=>{
        el.addEventListener('input', autosave);
        el.addEventListener('blur', autosave);
      });
      const box = card.querySelector('.image');
      const input = box?.querySelector('input[type="file"]');
      if (input){
        input.addEventListener('change', async e=>{
          const f = e.target.files?.[0]; if(!f) return;
          setBoxImage(box, await fileToDataURL(f));
          autosave();
        });
      }
      ['dragenter','dragover'].forEach(ev=> box?.addEventListener(ev, e=>{ e.preventDefault(); box.style.boxShadow='0 0 18px rgba(255,69,0,.85)'; }));
      ['dragleave','drop'].forEach(ev=> box?.addEventListener(ev, e=>{ e.preventDefault(); box.style.boxShadow=''; }));
      box?.addEventListener('drop', async e=>{
        const f = e.dataTransfer?.files?.[0]; if(!f) return;
        setBoxImage(box, await fileToDataURL(f));
        autosave();
      });
    }

    // Clone, wire, append
    const card = template.content.firstElementChild.cloneNode(true);
    wireCard(card);
    container.appendChild(card);
    card.scrollIntoView({ behavior:'smooth', block:'center' });
    autosave();
  });
});
</script>


    <footer class="footer">
      <div>Follow: Discord â€¢ Twitter â€¢ Steam â€¢ itch.io</div>
    </footer>
  </main>
  <script src="script.js"></script>

<script>
/* Elemental Imp: autosave + image handling + "+ Add demon" working */
(function () {
  const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
  const KEY = 'elementalImp:' + here;

  // ---------- helpers ----------
  function $(sel, ctx=document){ return Array.from(ctx.querySelectorAll(sel)); }
  function setStatus(msg){ const s = document.getElementById('save-status'); if (s) s.textContent = msg; }
  function debounce(fn, ms=400){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); setStatus('Savingâ€¦'); }; }
  function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }

  // Extract only the inner URL from background-image
  function getBoxImage(box){
    const bg = (box.style && box.style.backgroundImage) || '';
    const m = bg.match(/url\((['"]?)(.*?)\1\)/i);
    return m ? m[2] : '';
  }
  // Set background-image and clear placeholder text (keep the file input)
 function setBoxImage(box, src){
    if(!src) return;
    box.style.backgroundImage = `url(${src})`;
    box.classList.add('has-img');

    // Remove placeholder text, keep the file input
    const fileInput = box.querySelector('input[type="file"]');
    box.textContent = ''; // clears any text like "Image Placeholder"
    if (fileInput) box.appendChild(fileInput);
}

  // ---------- save/load ----------
  async function collect(){
    const textBlocks = $('[contenteditable="true"]').map(el => el.textContent.trim());
    const imgBoxes  = $('.image, .img').map(getBoxImage); // raw URLs/dataURLs only
    return { page: here, textBlocks, imgBoxes };
  }
  function apply(data){
    if (!data || data.page !== here) return;
    const texts = $('[contenteditable="true"]');
    (data.textBlocks || []).forEach((v,i)=> { if (texts[i]) texts[i].textContent = v || texts[i].textContent; });
    const boxes = $('.image, .img');
    (data.imgBoxes || []).forEach((src,i)=> { if (boxes[i] && src) setBoxImage(boxes[i], src); });
    setStatus('Loaded');
  }
  async function saveNow(){ try{ localStorage.setItem(KEY, JSON.stringify(await collect())); setStatus('Saved âœ“'); }catch(e){ console.error(e); setStatus('Save failed'); } }
  function loadNow(){ try{ const raw=localStorage.getItem(KEY); if (!raw) return; apply(JSON.parse(raw)); }catch(e){ console.error(e); } }
  const autosave = debounce(() => { collect().then(data=>{ try{ localStorage.setItem(KEY, JSON.stringify(data)); setStatus('Saved âœ“'); }catch(e){ console.error(e); setStatus('Save failed'); } }); }, 400);

  // ---------- wire existing UI ----------
  function wireImageBox(box){
    const input = box.querySelector('input[type="file"]');
    if (input && !input.dataset.wired){
      input.dataset.wired = '1';
      input.addEventListener('change', async e=>{
        const f = e.target.files && e.target.files[0]; if(!f) return;
        setBoxImage(box, await fileToDataURL(f));
        autosave();
      });
    }
    ['dragenter','dragover'].forEach(ev=> box.addEventListener(ev, e=>{ e.preventDefault(); box.style.boxShadow='0 0 18px rgba(255,69,0,.85)'; }));
    ['dragleave','drop'].forEach(ev=> box.addEventListener(ev, e=>{ e.preventDefault(); box.style.boxShadow=''; }));
    box.addEventListener('drop', async e=>{
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]; if(!f) return;
      setBoxImage(box, await fileToDataURL(f));
      autosave();
    });
  }
  function wireCard(card){
    if (card.dataset.wired) return;
    card.dataset.wired = '1';
    // remove button
    const rm = card.querySelector('.remove-card');
    rm && rm.addEventListener('click', ()=>{ card.remove(); autosave(); });
    // text autosave
    card.querySelectorAll('[contenteditable="true"]').forEach(el=>{
      el.addEventListener('input', autosave);
      el.addEventListener('blur', autosave);
    });
    // image box
    const box = card.querySelector('.image, .img');
    if (box) wireImageBox(box);
  }

  // ---------- DOMContentLoaded ----------
  document.addEventListener('DOMContentLoaded', () => {
    // highlight current nav
    document.querySelectorAll('.nav-bar .btn').forEach(a=>{
      if ((a.getAttribute('href')||'').toLowerCase() === here) a.classList.add('active');
    });

    // create controls if missing
    if (!document.querySelector('.controls')){
      const controls = document.createElement('div');
      controls.className = 'controls';
      controls.innerHTML = `
        <button class="btn" id="save-now">Save Now</button>
        <button class="btn" id="export-json">Export JSON</button>
        <label class="btn" for="import-json">Import JSON</label>
        <input id="import-json" type="file" accept="application/json" style="display:none">
        <button class="btn" id="reset-page">Reset</button>
        <span class="status-chip" id="save-status" aria-live="polite"></span>
      `;
      const main = document.querySelector('main') || document.body;
      const h2 = main.querySelector('section h2');
      (h2 && h2.parentElement) ? h2.parentElement.insertBefore(controls, h2.nextSibling) : main.prepend(controls);
    }

    // wire existing cards/boxes and text
    $('.cards .card').forEach(wireCard);
    $('.image, .img').forEach(wireImageBox);
    $('[contenteditable="true"]').forEach(el=>{
      el.addEventListener('input', autosave);
      el.addEventListener('blur', autosave);
    });

    // load saved state
    loadNow();

    // controls
    document.getElementById('save-now')?.addEventListener('click', saveNow);
    document.getElementById('reset-page')?.addEventListener('click', ()=>{
      if (confirm('Reset this page and clear saved data?')) { localStorage.removeItem(KEY); location.reload(); }
    });
    document.getElementById('export-json')?.addEventListener('click', async ()=>{
      const data = await collect();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (here.replace(/\.html$/,'') || 'page') + '-export.json';
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    });
    document.getElementById('import-json')?.addEventListener('change', e=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{ const data = JSON.parse(r.result); apply(data); localStorage.setItem(KEY, JSON.stringify(data)); setStatus('Imported âœ“'); }
        catch(err){ console.error(err); alert('Invalid JSON.'); }
      };
      r.readAsText(f);
    });

    // ---------- "+ Add demon" (works for all tiers) ----------
    // ensure we have a template
    let template = document.getElementById('card-template');
    if (!template){
      template = document.createElement('template');
      template.id = 'card-template';
      template.innerHTML = `
        <div class="card">
          <button class="remove-card" title="Remove this card">Ã—</button>
          <div class="image" title="Click to upload or drop an image">
            Image <input type="file" accept="image/*">
          </div>
          <div class="name" contenteditable="true">Name</div>
          <div class="desc" contenteditable="true">Short description of the demon, traits, and abilities.</div>
        </div>`;
      document.body.appendChild(template);
    }

    // delegate click for all current/future .add-card buttons
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.add-card');
      if (!btn) return;

      // find appropriate .cards container near the button
      let container = btn.closest('.tier')?.querySelector('.cards')
                   || btn.closest('section')?.querySelector('.cards');

      // fallback: create a .cards grid right after the button if none exists
      if (!container){
        container = document.createElement('div');
        container.className = 'cards';
        btn.insertAdjacentElement('afterend', container);
      }

      // clone a new card and wire it
      const card = template.content.firstElementChild.cloneNode(true);
      wireCard(card);
      container.appendChild(card);
      card.scrollIntoView({behavior:'smooth', block:'center'});
      autosave();
    });

    // in case some existing cards were not wired yet
    $('.cards .card').forEach(wireCard);
  });
})();
</script>
</body>
</html>
